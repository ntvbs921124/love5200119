<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Magic Xmas - Final Pro</title>
    <style>
        /* æ·±è‰²é«˜ç´šæ„ŸèƒŒæ™¯ */
        body { 
            margin: 0; 
            background: radial-gradient(circle at center, #0a121a 0%, #000 100%); 
            overflow: hidden; 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            touch-action: none; 
            color: #fff;
        }

        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        #video-hidden { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        
        /* æ¨™é¡Œèˆ‡ UI */
        .ui-header { position: absolute; top: 50px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        .main-title { font-size: 1.8rem; font-weight: 200; letter-spacing: 12px; color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); margin: 0; }
        
        #hint-text { position: absolute; bottom: 60px; width: 100%; text-align: center; z-index: 10; font-size: 0.85rem; color: rgba(255,255,255,0.6); letter-spacing: 2px; }

        /* è¨­å®šæŒ‰éˆ• */
        #lib-toggle { position: absolute; top: 35px; left: 25px; z-index: 150; background: transparent; border: 1px solid rgba(255, 215, 0, 0.3); color: #ffd700; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; backdrop-filter: blur(5px); }

        /* è¨­å®šå´é¢æ¿ */
        #library {
            position: absolute; top: 0; left: -100%; width: 85%; max-width: 350px; height: 100%; 
            background: rgba(5, 10, 15, 0.98); z-index: 200; transition: 0.5s; padding: 30px; 
            border-right: 1px solid rgba(255, 215, 0, 0.1); box-sizing: border-box; overflow-y: auto;
        }
        #library.open { left: 0; }
        .setting-item { margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .setting-item input { font-size: 12px; width: 130px; color: #888; }
        .setting-item img { width: 45px; height: 45px; border: 1px solid #ffd700; object-fit: cover; border-radius: 4px; }
        #save-btn { width: 100%; padding: 15px; background: transparent; color: #ffd700; border: 1px solid #ffd700; cursor: pointer; font-weight: bold; letter-spacing: 2px; margin-top: 10px; }
        
        /* ç›¸ç°¿æ¨¡å¼ */
        #gallery-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); z-index: 20; opacity: 0; pointer-events: none; transition: 0.8s; }
        #gallery-photo { max-width: 85%; max-height: 65%; border: 1px solid rgba(255,215,0,0.4); padding: 5px; background: #000; transition: opacity 0.3s; }

        body.gallery-active #canvas-container { filter: blur(25px) brightness(0.2); transform: scale(1.1); }
        body.gallery-active #gallery-container { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>
    <button id="lib-toggle">âš™</button>
    <div id="library">
        <h2 style="font-weight: 200; color: #ffd700; letter-spacing: 4px; margin-bottom: 30px;">SETTINGS</h2>
        <div id="file-inputs-container"></div>
        <button id="save-btn" onclick="savePhotos()">SAVE & RESTART</button>
        <p style="font-size: 10px; color: #666; margin-top: 15px;">* åœ–ç‰‡å°‡è‡ªå‹•å£“ç¸®ä»¥ç¯€çœç©ºé–“</p>
    </div>

    <video id="video-hidden" autoplay playsinline muted></video>
    <div id="canvas-container"></div>
    <div id="gallery-container"><img id="gallery-photo" src=""></div>

    <div class="ui-header">
        <h1 class="main-title">REAL MAGIC XMAS</h1>
    </div>
    <div id="hint-text">INITIALIZING...</div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. ç›¸ç°¿èˆ‡è‡ªå‹•å£“ç¸®é‚è¼¯ ---
        const photoKeys = ['xmas_p0', 'xmas_p1', 'xmas_p2', 'xmas_p3', 'xmas_p4', 'xmas_p5'];
        const container = document.getElementById('file-inputs-container');

        // ç”Ÿæˆè¨­å®šä»‹é¢
        photoKeys.forEach((key, i) => {
            const savedData = localStorage.getItem(key);
            const item = document.createElement('div');
            item.className = 'setting-item';
            item.innerHTML = `
                <input type="file" id="input-${i}" accept="image/*" onchange="window.handlePreview(${i})">
                <img id="prev-${i}" src="${savedData || ''}" style="display: ${savedData ? 'block' : 'none'}">
            `;
            container.appendChild(item);
        });

        // åœ–ç‰‡å£“ç¸®æ ¸å¿ƒå‡½æ•¸
        async function compressImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSide = 800; // é™åˆ¶æœ€å¤§å°ºå¯¸
                    if (width > height && width > maxSide) { height *= maxSide / width; width = maxSide; }
                    else if (height > maxSide) { width *= maxSide / height; height = maxSide; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // å“è³ªè¨­ç‚º 0.7
                };
            });
        }

        window.handlePreview = async (idx) => {
            const file = document.getElementById(`input-${idx}`).files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                document.getElementById('hint-text').innerText = "COMPRESSING...";
                const compressed = await compressImage(e.target.result);
                const img = document.getElementById(`prev-${idx}`);
                img.src = compressed;
                img.style.display = 'block';
                document.getElementById('hint-text').innerText = "READY";
            };
            reader.readAsDataURL(file);
        };

        window.savePhotos = () => {
            try {
                photoKeys.forEach((key, i) => {
                    const src = document.getElementById(`prev-${i}`).src;
                    if (src.startsWith('data:image')) localStorage.setItem(key, src);
                });
                alert("å„²å­˜æˆåŠŸï¼");
                location.reload();
            } catch (e) {
                alert("å„²å­˜ç©ºé–“ä¸è¶³ï¼Œè«‹å˜—è©¦ä¸Šå‚³è¼ƒå°‘æˆ–è¼ƒå°çš„åœ–ç‰‡ã€‚");
            }
        };

        const photos = photoKeys.map(k => localStorage.getItem(k)).filter(d => d);

        // --- 2. 3D ç²’å­è–èª•æ¨¹ (Python é‚è¼¯ç§»æ¤) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 60);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const worldGroup = new THREE.Group();
        scene.add(worldGroup);

        function createTree() {
            const points = []; const colors = [];
            // æ¨¹èº«ç²’å­ (èºæ—‹åˆ†ä½ˆ)
            for (let i = 0; i < 20000; i++) {
                const u = Math.random(); const h = Math.pow(u, 1.6);
                const y = 42 * h - 15;
                const baseR = Math.pow(1 - h, 1.1) * 16;
                const angle = u * 10 * Math.PI * 2 + (Math.random()-0.5)*0.5;
                const r = baseR * (0.85 + Math.random()*0.25);
                points.push(Math.cos(angle)*r, y, Math.sin(angle)*r);
                colors.push(1, 0.85, 0.2);
            }
            // æ¨¹é ‚æ„›å¿ƒ (Python æ–¹ç¨‹)
            let hc = 0;
            while(hc < 1000) {
                const x = (Math.random()-0.5)*2.5; const y = (Math.random()-0.5)*2.5;
                if(Math.pow(x*x+y*y-1, 3)-x*x*Math.pow(y,3) <= 0) {
                    points.push(x*3, 30+(y+1)*3, (Math.random()-0.5)*1.5);
                    colors.push(1, 0.1, 0.2); hc++;
                }
            }
            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(points, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            return new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.35, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending }));
        }
        worldGroup.add(createTree());

        // --- 3. AI æ‰‹å‹¢èˆ‡äº’å‹• ---
        const videoHidden = document.getElementById('video-hidden');
        let rotVel = 0.006, currentMode = 'tree', photoIdx = 0, cooldown = false;

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6 });
        hands.onResults((res) => {
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const m = res.multiHandLandmarks[0];
                const d = Math.hypot(m[4].x - m[8].x, m[4].y - m[8].y);
                if (!cooldown) {
                    if (currentMode === 'tree') {
                        rotVel = (m[8].x - 0.5) * 0.15;
                        if (d > 0.4) { 
                            currentMode = 'gallery'; document.body.classList.add('gallery-active');
                            if(photos.length > 0) document.getElementById('gallery-photo').src = photos[0];
                            triggerCooldown("GALLERY MODE");
                        }
                    } else {
                        if (d < 0.1) { currentMode = 'tree'; document.body.classList.remove('gallery-active'); triggerCooldown("TREE MODE"); }
                        if (m[8].x < 0.25) { photoIdx = (photoIdx+1)%photos.length; updatePhoto(); }
                        else if (m[8].x > 0.75) { photoIdx = (photoIdx-1+photos.length)%photos.length; updatePhoto(); }
                    }
                }
            }
        });

        function updatePhoto() {
            if(photos.length > 0) {
                const img = document.getElementById('gallery-photo');
                img.style.opacity = 0;
                setTimeout(() => { img.src = photos[photoIdx]; img.style.opacity = 1; }, 200);
                triggerCooldown();
            }
        }

        function triggerCooldown(msg) {
            cooldown = true; if(msg) document.getElementById('hint-text').innerText = msg;
            setTimeout(() => { cooldown = false; }, 800);
        }

        const cam = new Camera(videoHidden, { onFrame: async () => await hands.send({image: videoHidden}), width: 640, height: 480 });
        cam.start().then(() => document.getElementById('hint-text').innerText = "ğŸ– WAVE HAND TO START");

        function animate() { requestAnimationFrame(animate); worldGroup.rotation.y += rotVel; renderer.render(scene, camera); }
        animate();

        document.getElementById('lib-toggle').onclick = () => document.getElementById('library').classList.toggle('open');
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
