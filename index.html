<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Xmas - Particle Edition</title>
    <style>
        body { margin: 0; background: radial-gradient(circle at center, #050a0f 0%, #000 100%); overflow: hidden; font-family: sans-serif; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #video-hidden { position: absolute; width: 1px; height: 1px; opacity: 0; }
        
        /* UI 質感優化 */
        .ui-header { position: absolute; top: 40px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        .main-title { font-size: 1.8rem; letter-spacing: 12px; color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); font-weight: 200; margin: 0; }
        #status-box { position: absolute; bottom: 40px; width: 100%; text-align: center; z-index: 10; color: rgba(255,255,255,0.6); font-size: 0.8rem; letter-spacing: 2px; }
        
        #lib-toggle { position: absolute; top: 25px; left: 25px; z-index: 150; background: none; border: 1px solid rgba(255,215,0,0.3); color: #ffd700; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; backdrop-filter: blur(5px); }
        #library { position: absolute; top: 0; left: -100%; width: 280px; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; transition: 0.4s; padding: 25px; border-right: 1px solid rgba(255,215,0,0.2); color: #ccc; }
        #library.open { left: 0; }
        
        #gallery-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); z-index: 20; opacity: 0; pointer-events: none; transition: 0.5s; }
        #gallery-photo { max-width: 85%; max-height: 60%; border: 1px solid #ffd700; }
        
        body.gallery-active #canvas-container { filter: blur(15px) brightness(0.5); }
        body.gallery-active #gallery-container { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>
    <button id="lib-toggle">⚙</button>
    <div id="library">
        <h3 style="color:#ffd700; font-weight: 200;">SETTINGS</h3>
        <div id="file-inputs"></div>
        <button style="width:100%; padding:12px; background:none; border:1px solid #ffd700; color:#ffd700; margin-top:20px;" onclick="saveLocalPhotos()">SAVE & RESTART</button>
    </div>

    <video id="video-hidden" autoplay playsinline muted></video>
    <div id="canvas-container"></div>
    <div id="gallery-container"><img id="gallery-photo" src=""></div>

    <div class="ui-header">
        <h1 class="main-title">MERRY XMAS</h1>
    </div>
    <div id="status-box"><div id="hint-text">LOADING SENSORS...</div></div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 初始化參數 ---
        let photos = JSON.parse(localStorage.getItem('local_xmas_gallery')) || [];
        document.getElementById('lib-toggle').onclick = () => document.getElementById('library').classList.toggle('open');
        
        // --- 3D 引擎與場景 ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 20, 60);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const worldGroup = new THREE.Group();
        scene.add(worldGroup);

        // --- 粒子生成 (結合 Python 代碼邏輯) ---
        function createParticles() {
            const points = [];
            const colors = [];

            // 1. 聖誕樹螺旋粒子 (移植自你的 Python 參數)
            const treeCount = 20000;
            for (let i = 0; i < treeCount; i++) {
                const u = Math.random();
                const h = Math.pow(u, 1.6);
                const y = 40 * h; 
                const baseR = Math.pow(1 - h, 1.1) * 15;
                const angle = u * 9 * Math.PI * 2 + (Math.random() - 0.5) * 0.4;
                const r = baseR * (0.85 + Math.random() * 0.23);

                points.push(Math.cos(angle) * r, y - 15, Math.sin(angle) * r);
                colors.push(1, 0.8 + Math.random() * 0.2, 0.4 + Math.random() * 0.4); // 暖金色系
            }

            // 2. 地面環狀粒子
            const groundCount = 3000;
            const rings = [15, 20, 25];
            for (let i = 0; i < groundCount; i++) {
                const ring = rings[Math.floor(Math.random() * rings.length)];
                const r = ring + (Math.random() - 0.5) * 2;
                const angle = Math.random() * Math.PI * 2;
                points.push(Math.cos(angle) * r, -15, Math.sin(angle) * r);
                colors.push(0.5, 0.8, 1); // 冰藍色
            }

            // 3. 樹頂 3D 愛心 (移植自你的 Python 隱式方程)
            const heartCount = 1500;
            let hC = 0;
            while (hC < heartCount) {
                const x = (Math.random() - 0.5) * 2.6;
                const y = (Math.random() - 0.5) * 2.8;
                const f = Math.pow(x*x + y*y - 1, 3) - x*x * Math.pow(y, 3);
                if (f <= 0) {
                    points.push(x * 3, 28 + (y + 1) * 3, (Math.random() - 0.5) * 2);
                    colors.push(1, 0.2, 0.3); // 紅色
                    hC++;
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(points, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            const mat = new THREE.PointsMaterial({ size: 0.35, vertexColors: true, transparent: true, opacity: 0.8 });
            return new THREE.Points(geo, mat);
        }

        const particleSystem = createParticles();
        worldGroup.add(particleSystem);

        // --- AI 偵測與互動 ---
        const videoHidden = document.getElementById('video-hidden');
        let rotVel = 0.005, currentMode = 'tree', photoIdx = 0, gestureCooldown = false;

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
        hands.onResults((res) => {
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const m = res.multiHandLandmarks[0];
                const d = Math.sqrt(Math.pow(m[4].x - m[8].x, 2) + Math.pow(m[4].y - m[8].y, 2));
                if (!gestureCooldown) {
                    if (currentMode === 'tree') {
                        rotVel = (m[8].x - 0.5) * 0.1;
                        if (d > 0.4) { currentMode='gallery'; document.body.className='gallery-active'; updateHint("GALLERY MODE"); }
                    } else {
                        if (d < 0.1) { currentMode='tree'; document.body.className=''; updateHint("TREE MODE"); }
                        if (m[8].x < 0.25) changePhoto(1); else if (m[8].x > 0.75) changePhoto(-1);
                    }
                }
            }
        });

        async function initCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoHidden.srcObject = stream;
            const cam = new Camera(videoHidden, { onFrame: async () => { await hands.send({image: videoHidden}); } });
            cam.start();
            updateHint("SENSORS READY - WAVE YOUR HAND");
        }
        initCamera();

        function updateHint(t) { document.getElementById('hint-text').innerText = t; }
        function changePhoto(s) { /* 同前邏輯 */ }

        // --- 動畫循環 ---
        function animate() {
            requestAnimationFrame(animate);
            worldGroup.rotation.y += rotVel;
            // 讓粒子有微弱抖動感 (模擬 Python 中的隨機效果)
            particleSystem.rotation.y += 0.001;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
